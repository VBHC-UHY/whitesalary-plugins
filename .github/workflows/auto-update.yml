name: è‡ªåŠ¨æ›´æ–°æ’ä»¶åˆ—è¡¨

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'plugins/**'

jobs:
  validate:
    name: éªŒè¯æ’ä»¶
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: éªŒè¯æ’ä»¶ç»“æ„
        run: |
          echo "ğŸ” å¼€å§‹éªŒè¯æ’ä»¶..."
          
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "ğŸ“¦ æ£€æŸ¥æ’ä»¶: $plugin_name"
            
            # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
            if [ ! -f "${plugin_dir}plugin.py" ]; then
              echo "âŒ é”™è¯¯: ${plugin_name} ç¼ºå°‘ plugin.py"
              exit 1
            fi
            
            if [ ! -f "${plugin_dir}config.json" ]; then
              echo "âŒ é”™è¯¯: ${plugin_name} ç¼ºå°‘ config.json"
              exit 1
            fi
            
            # éªŒè¯ Python è¯­æ³•
            python -m py_compile "${plugin_dir}plugin.py" || {
              echo "âŒ é”™è¯¯: ${plugin_name}/plugin.py è¯­æ³•é”™è¯¯"
              exit 1
            }
            
            # éªŒè¯ JSON æ ¼å¼
            python -c "import json; json.load(open('${plugin_dir}config.json'))" || {
              echo "âŒ é”™è¯¯: ${plugin_name}/config.json JSONæ ¼å¼é”™è¯¯"
              exit 1
            }
            
            echo "âœ… ${plugin_name} éªŒè¯é€šè¿‡"
          done
          
          echo "ğŸ‰ æ‰€æœ‰æ’ä»¶éªŒè¯é€šè¿‡ï¼"

  update-list:
    name: æ›´æ–°æ’ä»¶åˆ—è¡¨
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ç”Ÿæˆæ’ä»¶åˆ—è¡¨
        run: |
          python scripts/generate_plugins_json.py
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add plugins.json README.md
          git diff --staged --quiet || git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ’ä»¶åˆ—è¡¨å’Œ README"
          git push

  auto-merge:
    name: è‡ªåŠ¨åˆå¹¶ PR
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: è‡ªåŠ¨åˆå¹¶
        uses: actions/github-script@v7
        with:
          script: |
            // æ£€æŸ¥ PR æ˜¯å¦åªä¿®æ”¹äº† plugins ç›®å½•
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const allInPlugins = files.every(f => f.filename.startsWith('plugins/'));
            
            if (allInPlugins) {
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['âœ… è‡ªåŠ¨éªŒè¯é€šè¿‡', 'ğŸ“¦ æ–°æ’ä»¶']
              });
              
              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ğŸ‰ **è‡ªåŠ¨éªŒè¯é€šè¿‡ï¼**\n\næ’ä»¶ç»“æ„å’Œè¯­æ³•æ£€æŸ¥å‡å·²é€šè¿‡ï¼ŒPR å°†è¢«è‡ªåŠ¨åˆå¹¶ã€‚\n\næ„Ÿè°¢ä½ çš„è´¡çŒ®ï¼'
              });
              
              // å¯ç”¨è‡ªåŠ¨åˆå¹¶
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  merge_method: 'squash'
                });
                console.log('PR å·²è‡ªåŠ¨åˆå¹¶');
              } catch (e) {
                console.log('æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†:', e.message);
              }
            }


